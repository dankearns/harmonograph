<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<title>Harmonograph Unleashed</title>
<link rel="stylesheet" href="hstyle.css" type="text/css"/>
<script type="text/javascript" src="/lib.js"></script>
<script>

var ren = require('./rendr');
var _ = require('underscore');
var Renderer = ren.Renderer;

window.onload = function() {
  window.requestAnimFrame = (function() {
    return window.requestAnimationFrame       ||
           window.webkitRequestAnimationFrame ||
           window.mozRequestAnimationFrame    ||
           window.oRequestAnimationFrame      ||
           window.msRequestAnimationFrame     ||
           function(cb, elem) {
             window.setTimeout(cb, 1000/60);
           };
  })();

  var df = function() {
    draw.width = window.innerWidth;
    draw.height = window.innerHeight;
    blit.width = window.innerWidth*.95;
    blit.height = window.innerHeight*.95;
  }

  var oldcfg = "";
  var makeConfig = function() {
    var doSpiro = false;
    var spiro = document.getElementById('params_xy').value;
    if(spiro.charAt(0) == 's') {
      spiro = spiro.slice(1);
      doSpiro = true;
      console.log("spiromode");
    }
    var pxy = spiro.split(',');
    pxy = _.map(pxy, function(i) { return Number(i); });
    var pap = document.getElementById('params_ap').value.split(',');
    pap = _.map(pap, function(i) { return Number(i); });
    var par = document.getElementById('params_r').value.split(',');
    par = _.map(par, function(i) { return Number(i); });

    var memo = [].concat(pxy,pap,par).join(",");
    var isNew = false;
   if(memo != oldcfg) {
      oldcfg = memo;
      isNew = true;
    }

   var c1 = ren.spiroConfig(pxy[0],pxy[1]);
   c1.xterms[0].damping = .002;
   c1.xterms[1].damping = .001;
   c1.yterms[0].damping = .002;
   c1.yterms[1].damping = .001;
   var c2 = ren.tableConfig(4, 2.5, 2, pxy[0], pxy[1], pap[0], pap[1], pap[2], pap[3], par[0], par[1]);

   return {
      isNew: isNew,
      cfg: doSpiro ? c1 : c2
   }
 };

  var palette = [
    '#d95208', '#ab3119', '#ef3328', '#d0150a', '#d65841', '#b76a39',
    '#c05639', '#c7606c', '#a76e37', '#d13b4a', '#d95f1f', '#c55331'
  ];

  var draw = document.getElementById('hdraw');
  var blit= document.getElementById('hblit');
  df();
  var pidx = 0;
  var pendown = true;
  var renderer = null;

  draw.onclick = function() {
    if(renderer == null) return;
    var i = pidx++ % palette.length;
    renderer.setColor(palette[i]);    
  };

  document.getElementById('Clear').onclick = function() {
    renderer.pause(true);
  };

  var moveToggle = false;
  document.getElementById('Move').onclick = function() {
    if(renderer) {
      renderer.wantMove(moveToggle);
      moveToggle = !moveToggle;
    }
  };

 document.getElementById('Start').onclick = function() {
    var cfg = makeConfig();

    if(renderer == null) {
      renderer = new Renderer(draw, blit, cfg.cfg);
      // set a color
      draw.onclick();
      // pen down
      renderer.startDrawing();
      renderer.resume();
    } else {
      if(cfg.isNew) {
        renderer.setConfig(cfg.cfg, function() {
          renderer.resume();
        });
      } else {
        renderer.resume();
      }
    }
 };

  document.getElementById('Stop').onclick = function() {
    renderer.pause(false);
  };
  document.getElementById('Pen').onclick = function() {
    pendown = !pendown;
    if(pendown) {
      renderer.startDrawing();
    } else {
      renderer.stopDrawing();
    }
 };

}
</script>
</head>

<body>

<div id="controls">
  <span class="toggle" id="hide">X</span>
  <form onSubmit="return false;">
  <table id="ctrls" width="200" border="0">

    <tr><td class="header" colspan="2">Swing Params</td></tr>
    <tr><td><label for="params_xy">x,y [0,1]</label></td>
    <td><input name="params_xy" id="params_xy" type="text" size="15" value="0.44,0.47"></td></tr>
    <tr><td><label for="params_ap">xa,xp,ya,yp</label></td>
    <td><input name="params_ap" id="params_ap" type="text" size="15" value="1.9,0,2.1,0"></td></tr>
    <tr><td><label for="params_r">ra,rp</label></td>
    <td><input name="params_r" id="params_r" type="text" size="15" value=".5,0.1"></td></tr>

    <tr><td class="header" colspan="2">Controls</td></tr>
    <tr><td colspan="2">
      <div class="bdiv">
        <button class="bc" id="Clear" name="Clear">Clear</button>
        <button class="bc" id="Start" name="Start">Start</button><br/>
        <button class="bc" id="Pen" name="Pen">&nbsp;Pen&nbsp;</button>
        <button class="bc" id="Stop" name="More">Stop&nbsp;</button><br/>
        <button class="bc" id="Move" name="Move">Move&nbsp;</button><br/>
    </div>
  </td></tr>
  </table>
  </form>
</div>

<div id="hg">
  <canvas class="draw" id="hdraw" width="1000", height="750"></canvas>
</div>

<div id="hgh">
    <canvas class="blit" id="hblit" width="1000", height="750"></canvas>
</div>

</body> </html>

